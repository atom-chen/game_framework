{
  "code": "import * as tslib_1 from \"tslib\";\r\nimport GameConfig from \"./GameConfig\";\r\nimport { GameData } from \"./script/common/GameData\";\r\nimport GamePreLoadingView from \"./script/loading/GamePreLoadingView\";\r\nimport SoundManager from \"./script/common/SoundManager\";\r\nimport { LevelManager } from \"./script/manager/LevelManager\";\r\nimport GameStateManager from \"./script/games/GameStateManager\";\r\nimport { EnterGameType, MoreGameIndex } from \"./script/games/CommonDefine\";\r\nimport { PlayerDataManager } from \"./script/common/GameDataManager\";\r\nimport ConfigManager from \"./script/games/ConfigManager\";\r\nimport ViewChangeManager from \"./script/games/ViewChangeManager\";\r\nimport { MiniManeger } from \"./script/minigame/MiniManeger\";\r\nimport InviteManager from \"./script/manager/InviteManager\";\r\nimport PlatformDY from \"./PlatformDY\";\r\nimport NativeBrige from \"./script/tool/NativeBrige\";\r\nimport SoundConst from \"./script/common/SoundConst\";\r\nimport NativeMgr from \"./script/tool/NativeMgr\";\r\nimport GameEvent from \"./script/games/GameEvent\";\r\nimport PlatfprmAiQiYi from \"./PlatfprmAiQiYi\";\r\nvar Main = (function (_super) {\r\n    tslib_1.__extends(Main, _super);\r\n    function Main() {\r\n        var _this = _super.call(this, { width: 1080, height: 1920, exportSceneToJson: true }) || this;\r\n        _this.isFlage = false;\r\n        GameConfig.init();\r\n        if (DeviceUtil.isNative()) {\r\n            SoundConst.perfix = \"resource/assets/sounds/ogg/\";\r\n            SoundConst.sufix = \".ogg\";\r\n        }\r\n        var onShow = function (obj) {\r\n            if (MiniManeger.instance.isAiQiYi()) {\r\n                return;\r\n            }\r\n            console.log(\"onShow...\", obj);\r\n            SoundManager.getInstance().playBgMusic();\r\n            if (ViewChangeManager.bGameOpen) {\r\n                if (ViewChangeManager.getInstance().CurLevelBase) {\r\n                    ViewChangeManager.getInstance().CurLevelBase.levelOnShow();\r\n                }\r\n            }\r\n        };\r\n        var onHide = function () {\r\n            if (MiniManeger.instance.isAiQiYi()) {\r\n                return;\r\n            }\r\n            console.log(\"onHide...\");\r\n            SoundManager.getInstance().pauseBgm();\r\n            if (ViewChangeManager.getInstance().CurLevelBase) {\r\n                ViewChangeManager.getInstance().CurLevelBase.levelOnHide();\r\n            }\r\n        };\r\n        var onAudioInterruptionBegin = function (res) {\r\n            console.log(\"onAudioInterruptionBegin\");\r\n        };\r\n        var onAudioInterruptionEnd = function (res) {\r\n            console.log(\"onAudioInterruptionEnd\");\r\n        };\r\n        if (DeviceUtil.isMiniGame()) {\r\n            GameData.getInstance().enterGameInfo = platform.getLaunchOptionsSync();\r\n            MiniManeger.instance.onShow(onShow);\r\n            MiniManeger.instance.onHide(onHide);\r\n            MiniManeger.instance.onAudioInterruptionBegin(onAudioInterruptionBegin);\r\n            MiniManeger.instance.onAudioInterruptionEnd(onAudioInterruptionEnd);\r\n            MiniManeger.instance.initMiniGame();\r\n        }\r\n        else {\r\n            Laya.stage.on(Laya.Event.FOCUS, _this, function () {\r\n                console.log(\"获取焦点\");\r\n                onShow(null);\r\n            });\r\n            Laya.stage.on(Laya.Event.BLUR, _this, function () {\r\n                console.log(\"失去焦点\");\r\n                onHide();\r\n            });\r\n        }\r\n        return _this;\r\n    }\r\n    Main.prototype.checkPlatform = function () {\r\n        this.loadingView = new GamePreLoadingView();\r\n        SceneManager.getInstance().openSceneInstance(this.loadingView);\r\n        console.log(\"检验平台---\");\r\n        var self = this;\r\n        if (window[\"loadingH5\"]) {\r\n            window[\"loadingH5\"](100);\r\n        }\r\n        if (window[\"loadingView\"]) {\r\n            window[\"NativeBrige\"] = NativeBrige.getInstance();\r\n            window[\"loadingView\"].loading(100);\r\n        }\r\n        window[\"onEventNotify\"] = PlatfprmAiQiYi.processAppMsg;\r\n        var resUrl = \"./\";\r\n        if (DeviceUtil.isQQMiniGame()) {\r\n            GameData.getInstance().gameId = \"1050\";\r\n            Laya.timer.loop(10000, window, function () {\r\n                console.log(\"qq加速回收---\");\r\n                platform.triggerGC();\r\n            });\r\n            resUrl = GameData.getInstance().qqMiniGameResUrl;\r\n            self.loadPreLoadRes(resUrl + \"configs/infos.json?v=\" + Math.random());\r\n        }\r\n        else if (DeviceUtil.isWXMiniGame()) {\r\n            GameData.getInstance().gameId = \"1054\";\r\n            Laya.timer.loop(10000, window, function () {\r\n                console.log(\"wx加速回收---\");\r\n                platform.triggerGC();\r\n            });\r\n            resUrl = GameData.getInstance().wxMiniGameResUrl;\r\n            self.loadPreLoadRes(resUrl + \"configs/infos.json?v=\" + Math.random());\r\n        }\r\n        else if (DeviceUtil.isTTMiniGame()) {\r\n            GameData.getInstance().gameId = \"1049\";\r\n            Laya.timer.loop(10000, window, function () {\r\n                console.log(\"tt加速回收---\");\r\n                platform.triggerGC();\r\n            });\r\n            resUrl = GameData.getInstance().ttMiniGameResUrl;\r\n            self.loadPreLoadRes(resUrl + \"configs/infos.json?v=\" + Math.random());\r\n        }\r\n        else if (DeviceUtil.isNative()) {\r\n            resUrl = \"\";\r\n            GameData.getInstance().gameId = \"1049\";\r\n            self.loadPreLoadRes(resUrl + \"configs/infos.json\");\r\n            Laya.timer.once(5000, window, function () {\r\n                NativeMgr.getInstance().showAdView();\r\n            });\r\n        }\r\n        else {\r\n            GameData.getInstance().gameId = \"1049\";\r\n            self.initDebug();\r\n            self.loadPreLoadRes(resUrl + \"configs/infos.json\");\r\n        }\r\n        if (DeviceUtil.isMiniGame()) {\r\n            ResUtil.getIntance().defaultOriginUrl = resUrl;\r\n            ResUtil.getIntance().addVersionPrefix(resUrl);\r\n        }\r\n    };\r\n    Main.prototype.loadPreLoadRes = function (resUrl) {\r\n        this.initInfos(resUrl);\r\n        Laya.timer.once(5000, this, this.loadPreLoadRes, [resUrl]);\r\n    };\r\n    Main.prototype.enableFileConfig = function () {\r\n        Laya.timer.clearAll(this);\r\n        this.loadFileConfig(\"fileconfig.json\");\r\n        if (this.isFlage) {\r\n            return;\r\n        }\r\n        this.isFlage = true;\r\n        console.log(BaseConst.infos);\r\n        GameData.getInstance().initConfig(BaseConst.infos);\r\n        if (DeviceUtil.isWXMiniGame()) {\r\n            PlatformDY.url = BaseConst.infos.gameInfo.url;\r\n        }\r\n        MiniManeger.instance.showBannerAd();\r\n        MiniManeger.instance.checkCityInfo();\r\n    };\r\n    Main.prototype.platformLogin = function () {\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            var res_1, self_1, enter, res_2;\r\n            var _this = this;\r\n            return tslib_1.__generator(this, function (_a) {\r\n                switch (_a.label) {\r\n                    case 0:\r\n                        if (!(DeviceUtil.isQQMiniGame() || DeviceUtil.isWXMiniGame() || DeviceUtil.isTTMiniGame())) return [3, 8];\r\n                        console.log(\"开始登录\");\r\n                        self_1 = this;\r\n                        if (DeviceUtil.isQQMiniGame()) {\r\n                            MiniManeger.instance.initBoxAd();\r\n                            MiniManeger.instance.initBlockAd();\r\n                        }\r\n                        enter = function () { return tslib_1.__awaiter(_this, void 0, void 0, function () {\r\n                            var isAuthorize, userinfo, obj, scene, userInfo;\r\n                            return tslib_1.__generator(this, function (_a) {\r\n                                switch (_a.label) {\r\n                                    case 0:\r\n                                        if (!(DeviceUtil.isWXMiniGame() || DeviceUtil.isQQMiniGame() || DeviceUtil.isTTMiniGame())) return [3, 9];\r\n                                        if (!(BaseConst.infos.gameInfo.isDY && DeviceUtil.isWXMiniGame())) return [3, 4];\r\n                                        return [4, platform.checkIsAuthorize()];\r\n                                    case 1:\r\n                                        isAuthorize = _a.sent();\r\n                                        userinfo = null;\r\n                                        if (!isAuthorize) return [3, 3];\r\n                                        return [4, MiniManeger.instance.initUserTemp()];\r\n                                    case 2:\r\n                                        userinfo = _a.sent();\r\n                                        _a.label = 3;\r\n                                    case 3:\r\n                                        if (userinfo == null) {\r\n                                            userinfo = { nickName: '', avatarUrl: '', gender: '' };\r\n                                        }\r\n                                        obj = GameData.getInstance().enterGameInfo;\r\n                                        scene = obj.query.scene == undefined ? null : obj.query.scene;\r\n                                        PlatformDY.getOpenidAndAuthorzia({\r\n                                            code: res_1, nickName: userinfo.nickName, avatarUrl: userinfo.avatarUrl, gender: userinfo.gender, scene: decodeURIComponent(scene)\r\n                                        }).then(function (dyUser) {\r\n                                            GameData.getInstance().userInfo.openId = dyUser.openid;\r\n                                            var strOpenIdOther = GameData.getInstance().enterGameInfo.query[\"openid\"];\r\n                                            console.log(\"strOpenIdOther = \", strOpenIdOther);\r\n                                            if (strOpenIdOther && strOpenIdOther != \"\") {\r\n                                                InviteManager.getInstance().judgeInvite();\r\n                                                console.log(\"createUserInfoButton 用户信息 : \", GameData.getInstance().userInfo);\r\n                                            }\r\n                                            if (BaseConst.infos.gameInfo.isDY) {\r\n                                                PlatformDY.getGameList().then(function () {\r\n                                                    GameData.getInstance().weCatMiniIconsInfo = [];\r\n                                                    var nLen = PlatformDY.gameListInfos.length;\r\n                                                    for (var i = 0; i < nLen; ++i) {\r\n                                                        var stData = new MoreGameIndex();\r\n                                                        stData.ad_id = PlatformDY.gameListInfos[i].id;\r\n                                                        stData.ad_img = PlatformDY.gameListInfos[i].img;\r\n                                                        stData.name = PlatformDY.gameListInfos[i].title;\r\n                                                        stData.ad_appid = PlatformDY.gameListInfos[i].appid;\r\n                                                        stData.url = PlatformDY.gameListInfos[i].url;\r\n                                                        GameData.getInstance().weCatMiniIconsInfo.push(stData);\r\n                                                    }\r\n                                                    console.log(\"GameData.getInstance().weCatMiniIconsInfo = \", GameData.getInstance().weCatMiniIconsInfo);\r\n                                                });\r\n                                            }\r\n                                            PlayerDataManager.getInstance().GetData();\r\n                                        });\r\n                                        return [3, 9];\r\n                                    case 4:\r\n                                        console.log(\"登陆信息:\", res_1);\r\n                                        GameData.getInstance().userInfo.openId = res_1.openid;\r\n                                        GameData.getInstance().userInfo.sessionKey = res_1.session_key;\r\n                                        console.log(\"用户信息 : \", GameData.getInstance().userInfo);\r\n                                        if (!DeviceUtil.isTTMiniGame()) return [3, 6];\r\n                                        return [4, platform.getUserInfo()];\r\n                                    case 5:\r\n                                        userInfo = _a.sent();\r\n                                        console.log(\"getUserInfo:\", userInfo);\r\n                                        GameData.getInstance().userInfo.nick = userInfo.nickName;\r\n                                        GameData.getInstance().userInfo.avatarUrl = userInfo.avatarUrl;\r\n                                        console.log(\"授权用户信息 : \", GameData.getInstance().userInfo);\r\n                                        return [3, 8];\r\n                                    case 6: return [4, MiniManeger.instance.initUserTemp()];\r\n                                    case 7:\r\n                                        _a.sent();\r\n                                        _a.label = 8;\r\n                                    case 8:\r\n                                        PlayerDataManager.getInstance().GetData();\r\n                                        _a.label = 9;\r\n                                    case 9: return [2];\r\n                                }\r\n                            });\r\n                        }); };\r\n                        if (!DeviceUtil.isTTMiniGame()) return [3, 2];\r\n                        return [4, platform.login()];\r\n                    case 1:\r\n                        res_2 = _a.sent();\r\n                        if (res_2) {\r\n                            res_2 = JSON.parse(res_2);\r\n                            console.log(\"登陆信息:\", res_2);\r\n                            GameData.getInstance().userInfo.openId = res_2.openid;\r\n                            GameData.getInstance().userInfo.sessionKey = res_2.session_key;\r\n                            console.log(\"用户信息 : \", GameData.getInstance().userInfo);\r\n                        }\r\n                        PlayerDataManager.getInstance().GetData();\r\n                        return [3, 7];\r\n                    case 2:\r\n                        if (!(BaseConst.infos.gameInfo.isDY && DeviceUtil.isWXMiniGame())) return [3, 4];\r\n                        return [4, platform.DYlogin()];\r\n                    case 3:\r\n                        res_1 = _a.sent();\r\n                        return [3, 6];\r\n                    case 4: return [4, platform.login()];\r\n                    case 5:\r\n                        res_1 = _a.sent();\r\n                        res_1 = JSON.parse(res_1);\r\n                        _a.label = 6;\r\n                    case 6:\r\n                        enter();\r\n                        _a.label = 7;\r\n                    case 7: return [3, 9];\r\n                    case 8:\r\n                        GameData.getInstance().userInfo.openId = GameData.getInstance().userInfo.sessionKey = DeviceUtil.getDeviceNo();\r\n                        PlayerDataManager.getInstance().GetData();\r\n                        _a.label = 9;\r\n                    case 9: return [2];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    Main.prototype.loadRes = function () {\r\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\r\n            var resUrl, loadresUrl, group, nLevelGroup, self;\r\n            var _this = this;\r\n            return tslib_1.__generator(this, function (_a) {\r\n                switch (_a.label) {\r\n                    case 0: return [4, this.platformLogin()];\r\n                    case 1:\r\n                        _a.sent();\r\n                        console.log(\"loadRes---\");\r\n                        console.log(\"加载预加载资源--\");\r\n                        resUrl = \"\";\r\n                        if (DeviceUtil.isQQMiniGame()) {\r\n                            Laya.loader.create(\"configs/gameQQInfo.json\" + GameData.getInstance().randomTime, Laya.Handler.create(this, function (infos) {\r\n                                GameData.getInstance().gameQQInfo = infos;\r\n                            }), null);\r\n                        }\r\n                        if (!DeviceUtil.isNative()) return [3, 4];\r\n                        return [4, ResUtil.getIntance().loadThms(resUrl + \"resource/default.thm.json\")];\r\n                    case 2:\r\n                        _a.sent();\r\n                        return [4, ResUtil.getIntance().loadRESConfig(resUrl + \"resource/default.res.json\")];\r\n                    case 3:\r\n                        _a.sent();\r\n                        return [3, 7];\r\n                    case 4:\r\n                        loadresUrl = resUrl;\r\n                        return [4, ResUtil.getIntance().loadThms(loadresUrl + \"resource/default.thm.json?v=\" + Math.random())];\r\n                    case 5:\r\n                        _a.sent();\r\n                        return [4, ResUtil.getIntance().loadRESConfig(loadresUrl + \"resource/default.res.json?v=\" + Math.random())];\r\n                    case 6:\r\n                        _a.sent();\r\n                        _a.label = 7;\r\n                    case 7:\r\n                        if (DeviceUtil.isWXMiniGame() && !BaseConst.infos.gameInfo.isDY) {\r\n                            Laya.loader.load(resUrl + \"configs/wxmoregame.json?v=\" + Math.random(), Laya.Handler.create(this, function (res) {\r\n                                if (typeof (res) == \"string\") {\r\n                                    res = JSON.parse(res);\r\n                                }\r\n                                var infos = [];\r\n                                for (var i = 0, len = res.iconList.length; i < len; i++) {\r\n                                    res.iconList[i].ad_img = \"https://package.32yx.com/ecy_game_small/laya/girl/wx_res/moregame/\" + res.iconList[i].ad_img;\r\n                                }\r\n                                GameData.getInstance().weCatMiniIconsInfo = res.iconList;\r\n                            }));\r\n                        }\r\n                        else if (DeviceUtil.isTTMiniGame()) {\r\n                            Laya.loader.load(resUrl + \"configs/ttmoregame.json?v=\" + Math.random(), Laya.Handler.create(this, function (res) {\r\n                                if (typeof (res) == \"string\") {\r\n                                    res = JSON.parse(res);\r\n                                }\r\n                                var infos = [];\r\n                                for (var i = 0, len = res.iconList.length; i < len; i++) {\r\n                                    res.iconList[i].ad_img = \"https://package.32yx.com/ecy_game_small/laya/girl/tt/moregame/\" + res.iconList[i].ad_img;\r\n                                }\r\n                                GameData.getInstance().weCatMiniIconsInfo = res.iconList;\r\n                            }));\r\n                        }\r\n                        group = [\"gamehome\"];\r\n                        nLevelGroup = PlayerDataManager.getInstance().getCurLevelToChallenge();\r\n                        if (DeviceUtil.isTTMiniGame() && BaseConst.infos.gameInfo.openPsAward == 0) {\r\n                            nLevelGroup = nLevelGroup + 1;\r\n                        }\r\n                        ViewChangeManager.getInstance().rigestBufferLoadingView();\r\n                        if (nLevelGroup == 3)\r\n                            nLevelGroup = 2;\r\n                        group.push(nLevelGroup.toString());\r\n                        self = this;\r\n                        ResUtil.getIntance().fastLoadGroups(group, function () {\r\n                            ViewChangeManager.getInstance().showBufferLoadingView();\r\n                            ConfigManager.getInstance().initConfigInfo().then(function () {\r\n                                if (PlayerDataManager.getInstance().bPlayerLoadFinish || !BaseConst.infos.gameInfo.isDY) {\r\n                                    _this.funcAfterLodRed();\r\n                                }\r\n                                else {\r\n                                    PlayerDataManager.getInstance().bResLoadFinish = true;\r\n                                    EventMgr.getInstance().addEvent(GameEvent.HAS_GET_PLAYER_DATA, _this, _this.funcAfterLodRed);\r\n                                }\r\n                            });\r\n                            SoundManager.getInstance().isEnterView = true;\r\n                            self.onPlayMusic();\r\n                        }, function (cur, total) {\r\n                            self.loadingView.progress(cur, total);\r\n                        });\r\n                        return [2];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    Main.prototype.onPlayMusic = function () {\r\n        SoundManager.getInstance().bgm = 'bg';\r\n    };\r\n    Main.prototype.funcAfterLodRed = function () {\r\n        console.log(\"配置加载完成---\");\r\n        PlayerDataManager.getInstance().initGoods();\r\n        PlayerDataManager.getInstance().refreshOffLinePS();\r\n        if (!PlayerDataManager.getInstance().bIsNewPlayer) {\r\n            GameStateManager.getInstance().levelState = EnterGameType.enum_EnterGameType_GameHome;\r\n        }\r\n        else {\r\n            GameStateManager.getInstance().levelState = EnterGameType.enum_EnterGameType_ChooseLevel;\r\n            PlayerDataManager.getInstance().SaveData();\r\n        }\r\n        PlayerDataManager.getInstance().setCurLevel(PlayerDataManager.getInstance().getLevelToChangeMaxLevel() - 1);\r\n        LevelManager.getInstance().createLevelScene(PlayerDataManager.getInstance().getLevelToChangeMaxLevel());\r\n        ViewChangeManager.getInstance().showCommonView();\r\n        ViewChangeManager.getInstance().showImageExit();\r\n        ViewChangeManager.bGameOpen = true;\r\n        ResUtil.getIntance().loadGroups(['success', 'game', \"panel\", \"common\"]);\r\n        ViewChangeManager.getInstance().hideBufferLoadingView();\r\n    };\r\n    return Main;\r\n}(BaseContent));\r\nnew Main();\r\n",
  "references": [
    "F:/gitpro/ecy_game_framework/game_framework_ecy/game_framework_ecy/src/GameConfig.ts",
    "F:/gitpro/ecy_game_framework/game_framework_ecy/game_framework_ecy/src/script/common/GameData.ts",
    "F:/gitpro/ecy_game_framework/game_framework_ecy/game_framework_ecy/src/script/loading/GamePreLoadingView.ts",
    "F:/gitpro/ecy_game_framework/game_framework_ecy/game_framework_ecy/src/script/common/SoundManager.ts",
    "F:/gitpro/ecy_game_framework/game_framework_ecy/game_framework_ecy/src/script/manager/LevelManager.ts",
    "F:/gitpro/ecy_game_framework/game_framework_ecy/game_framework_ecy/src/script/games/GameStateManager.ts",
    "F:/gitpro/ecy_game_framework/game_framework_ecy/game_framework_ecy/src/script/games/CommonDefine.ts",
    "F:/gitpro/ecy_game_framework/game_framework_ecy/game_framework_ecy/src/script/common/GameDataManager.ts",
    "F:/gitpro/ecy_game_framework/game_framework_ecy/game_framework_ecy/src/script/games/ConfigManager.ts",
    "F:/gitpro/ecy_game_framework/game_framework_ecy/game_framework_ecy/src/script/games/ViewChangeManager.ts",
    "F:/gitpro/ecy_game_framework/game_framework_ecy/game_framework_ecy/src/script/minigame/MiniManeger.ts",
    "F:/gitpro/ecy_game_framework/game_framework_ecy/game_framework_ecy/src/script/manager/InviteManager.ts",
    "F:/gitpro/ecy_game_framework/game_framework_ecy/game_framework_ecy/src/PlatformDY.ts",
    "F:/gitpro/ecy_game_framework/game_framework_ecy/game_framework_ecy/src/script/tool/NativeBrige.ts",
    "F:/gitpro/ecy_game_framework/game_framework_ecy/game_framework_ecy/src/script/common/SoundConst.ts",
    "F:/gitpro/ecy_game_framework/game_framework_ecy/game_framework_ecy/src/script/tool/NativeMgr.ts",
    "F:/gitpro/ecy_game_framework/game_framework_ecy/game_framework_ecy/src/script/games/GameEvent.ts",
    "F:/gitpro/ecy_game_framework/game_framework_ecy/game_framework_ecy/src/PlatfprmAiQiYi.ts"
  ]
}
